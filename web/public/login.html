<div class="login-page">
    <div class="form">
        <h1>&#9820; ARKAUTHN</h1>
        <div class="error-message" id="error-message">用户名或密码错误，请重试。</div>
        <form class="login-form" method="post">
            <input type="text" placeholder="用户名" name="username" required />
            <input type="password" placeholder="密码" name="password" required />
            <input type="hidden" id="redirect" name="redirect" value="" />
            <button type="submit">登录</button>
        </form>
    </div>
</div>

<script type="module">
    import Cap from '/vendor/capjs/cap.js'

    window.CAP_CUSTOM_WASM_URL = '/vendor/capjs/cap_wasm.min.js';

    window.onload = function () {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('e')) {
            document.getElementById('error-message').style.display = 'block';
        }

        if (urlParams.has('r')) {
            document.getElementById('redirect').value = urlParams.get('r');
        }

        const form = document.querySelector('.login-form');
        const submitBtn = form.querySelector('button[type="submit"]');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (submitBtn.disabled) return;
            
            const originalText = submitBtn.innerText;
            submitBtn.disabled = true;
            submitBtn.innerText = '安全验证中...';

            try {
                const cap = new Cap({
                    apiEndpoint: '/api/cap/',
                });
                const solution = await cap.solve();
                
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'cap_token';
                input.value = solution.token;
                form.appendChild(input);
                
                form.submit();
            } catch (err) {
                console.error(err);
                alert('验证失败，请重试');
                submitBtn.disabled = false;
                submitBtn.innerText = originalText;
            }
        });
    }
</script>