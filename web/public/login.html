<div class="login-page">
    <div class="form">
        <h1>&#9820; ARKAUTHN</h1>
        <div class="error-message" id="error-message">用户名或密码错误，请重试。</div>
        <form class="login-form" method="post">
            <input type="text" placeholder="用户名" name="username" required />
            <input type="password" placeholder="密码" name="password" required />
            
            <div class="duration-selector">
                <label>
                    <input type="radio" name="duration-option" value="3600" checked>
                    <span>1小时</span>
                </label>
                <label>
                    <input type="radio" name="duration-option" value="86400">
                    <span>1天</span>
                </label>
                <label>
                    <input type="radio" name="duration-option" value="2592000">
                    <span>30天</span>
                </label>
                <label>
                    <input type="radio" name="duration-option" value="31536000">
                    <span>1年</span>
                </label>
            </div>
            <input type="hidden" name="duration" id="duration-input" value="3600" />

            <input type="hidden" id="redirect" name="redirect" value="" />
            <button type="submit">登录</button>
        </form>
    </div>
</div>

<script type="module">
    // 配置必须在加载 CapJS 之前设置，否则会回退到 CDN
    // 使用绝对路径以避免 Web Worker 中的解析问题
    window.CAP_CUSTOM_WASM_URL = new URL('/vendor/capjs/cap_wasm.min.js', window.location.href).href;

    // 使用动态导入确保配置已生效
    const { default: Cap } = await import('/vendor/capjs/cap.js');

    window.onload = function () {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('e')) {
            document.getElementById('error-message').style.display = 'block';
        }

        if (urlParams.has('r')) {
            document.getElementById('redirect').value = urlParams.get('r');
        }

        const form = document.querySelector('.login-form');
        const submitBtn = form.querySelector('button[type="submit"]');
        const usernameInput = form.querySelector('input[name="username"]');

        // Load saved username
        const savedUsername = localStorage.getItem('arkauthn_username');
        if (savedUsername) {
            usernameInput.value = savedUsername;
        }

        // Duration selector logic
        const durationInputs = document.querySelectorAll('input[name="duration-option"]');
        const durationInput = document.getElementById('duration-input');
        
        durationInputs.forEach(input => {
            input.addEventListener('change', (e) => {
                if (e.target.checked) {
                    durationInput.value = e.target.value;
                }
            });
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Save username
            localStorage.setItem('arkauthn_username', usernameInput.value);
            
            if (submitBtn.disabled) return;
            
            const originalText = submitBtn.innerText;
            submitBtn.disabled = true;
            submitBtn.innerText = '安全验证中...';

            try {
                const cap = new Cap({
                    apiEndpoint: '/api/cap/',
                });
                const solution = await cap.solve();
                
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'cap_token';
                input.value = solution.token;
                form.appendChild(input);
                
                form.submit();
            } catch (err) {
                console.error(err);
                alert('验证失败，请重试');
                submitBtn.disabled = false;
                submitBtn.innerText = originalText;
            }
        });
    }
</script>